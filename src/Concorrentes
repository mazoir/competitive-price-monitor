/*
=======================================================
SCRIPT DE CRIAÃ‡ÃƒO DE TABELAS
Sistema: Monitor de PreÃ§os de Concorrentes
Autor: Mazoir Aguiar
Data: Novembro 2025
=======================================================
*/

-- =====================================================
-- 1. TABELA DE CONCORRENTES
-- =====================================================
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Concorrentes')
BEGIN
    CREATE TABLE Concorrentes (
        ConcorrenteID INT PRIMARY KEY IDENTITY(1,1),
        Nome NVARCHAR(100) NOT NULL,
        URLBase NVARCHAR(500) NOT NULL,
        UltimaAtualizacao DATETIME DEFAULT GETDATE(),
        Ativo BIT DEFAULT 1,
        
        CONSTRAINT UQ_Concorrente_Nome UNIQUE (Nome)
    );
    
    PRINT 'âœ… Tabela Concorrentes criada com sucesso!'
END
GO

-- =====================================================
-- 2. TABELA DE PRODUTOS MONITORADOS
-- =====================================================
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Produtos')
BEGIN
    CREATE TABLE Produtos (
        ProdutoID INT PRIMARY KEY IDENTITY(1,1),
        SKU NVARCHAR(50) NOT NULL,
        Nome NVARCHAR(200) NOT NULL,
        Categoria NVARCHAR(100),
        PrecoReferencia DECIMAL(10,2),
        DataCadastro DATETIME DEFAULT GETDATE(),
        
        CONSTRAINT UQ_Produto_SKU UNIQUE (SKU)
    );
    
    PRINT 'âœ… Tabela Produtos criada com sucesso!'
END
GO

-- =====================================================
-- 3. TABELA DE HISTÃ“RICO DE PREÃ‡OS
-- =====================================================
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'HistoricoPrecos')
BEGIN
    CREATE TABLE HistoricoPrecos (
        HistoricoID INT PRIMARY KEY IDENTITY(1,1),
        ProdutoID INT NOT NULL,
        ConcorrenteID INT NOT NULL,
        Preco DECIMAL(10,2) NOT NULL,
        Disponivel BIT DEFAULT 1,
        DataColeta DATETIME DEFAULT GETDATE(),
        
        CONSTRAINT FK_Historico_Produto FOREIGN KEY (ProdutoID) 
            REFERENCES Produtos(ProdutoID),
        CONSTRAINT FK_Historico_Concorrente FOREIGN KEY (ConcorrenteID) 
            REFERENCES Concorrentes(ConcorrenteID)
    );
    
    -- Ãndice para otimizar consultas por data
    CREATE NONCLUSTERED INDEX IX_HistoricoPrecos_DataColeta 
        ON HistoricoPrecos(DataColeta DESC);
    
    PRINT 'âœ… Tabela HistoricoPrecos criada com sucesso!'
END
GO

-- =====================================================
-- 4. VIEW: ÃšLTIMOS PREÃ‡OS POR PRODUTO
-- =====================================================
CREATE OR ALTER VIEW vw_UltimosPrecos AS
SELECT 
    p.ProdutoID,
    p.SKU,
    p.Nome AS NomeProduto,
    c.Nome AS Concorrente,
    hp.Preco,
    hp.Disponivel,
    hp.DataColeta,
    -- Calcula diferenÃ§a percentual vs. preÃ§o de referÃªncia
    CASE 
        WHEN p.PrecoReferencia > 0 THEN 
            ROUND(((hp.Preco - p.PrecoReferencia) / p.PrecoReferencia * 100), 2)
        ELSE NULL 
    END AS DiferencaPercentual
FROM 
    HistoricoPrecos hp
    INNER JOIN Produtos p ON hp.ProdutoID = p.ProdutoID
    INNER JOIN Concorrentes c ON hp.ConcorrenteID = c.ConcorrenteID
WHERE 
    hp.DataColeta = (
        SELECT MAX(DataColeta) 
        FROM HistoricoPrecos hp2 
        WHERE hp2.ProdutoID = hp.ProdutoID 
          AND hp2.ConcorrenteID = hp.ConcorrenteID
    )
GO

PRINT 'âœ… View vw_UltimosPrecos criada com sucesso!'
PRINT '================================================='
PRINT 'ðŸŽ‰ ESTRUTURA DO BANCO DE DADOS CRIADA COM SUCESSO!'
PRINT '================================================='
```
